<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppsFlyer SKAN Interactive Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            animation: slideIn 0.6s ease;
        }

        .nav-tab {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #667eea;
            position: relative;
            overflow: hidden;
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .content-panel {
            background: white;
            border-radius: 0 10px 10px 10px;
            padding: 30px;
            min-height: 500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            animation: fadeInUp 0.7s ease;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: contentFade 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes contentFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .section-title {
            color: #667eea;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            position: relative;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, #764ba2, transparent);
        }

        .info-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
        }

        .flow-diagram {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }

        .flow-step {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .flow-step:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .flow-arrow {
            text-align: center;
            color: #667eea;
            font-size: 24px;
            margin: 10px 0;
            animation: bounce 2s infinite;
        }

        .code-container {
            background: #1e1e1e;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .code-header {
            background: #2d2d2d;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }

        .code-language {
            color: #4fc3f7;
            font-weight: 600;
            font-size: 14px;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #45a049;
            transform: scale(1.05);
        }

        .code-content {
            padding: 20px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            color: #d4d4d4;
            white-space: pre;
            max-height: 400px;
            overflow-y: auto;
        }

        .schema-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .schema-card {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .schema-card::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: top 0.3s ease;
            z-index: 0;
        }

        .schema-card:hover::before {
            top: 0;
        }

        .schema-card:hover {
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .schema-card * {
            position: relative;
            z-index: 1;
        }

        .bit-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .schema-card:hover .bit-value {
            color: white;
        }

        .event-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .event-type {
            font-size: 12px;
            color: #666;
        }

        .schema-card:hover .event-type {
            color: rgba(255,255,255,0.9);
        }

        .interactive-demo {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            color: white;
        }

        .demo-controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .demo-btn {
            background: white;
            color: #f5576c;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .demo-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(245, 87, 108, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }

        .demo-btn:hover::after {
            width: 300px;
            height: 300px;
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .demo-output {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 100px;
            backdrop-filter: blur(10px);
        }

        .highlight {
            background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
            padding: 2px 8px;
            border-radius: 5px;
            color: #2d3436;
            font-weight: 600;
            display: inline-block;
            margin: 2px;
            animation: pulse 2s infinite;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: blink 2s infinite;
        }

        .status-granted {
            background: #00b894;
        }

        .status-denied {
            background: #ff7675;
        }

        .code-section {
            margin: 30px 0;
        }

        .code-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 AppsFlyer SKAN Interactive Demo</h1>
            <p>Complete Technical Guide for App Development Teams</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview', this)">📊 SKAN Overview</button>
            <button class="nav-tab" onclick="showTab('appsflyer', this)">🎯 AppsFlyer SKAN</button>
            <button class="nav-tab" onclick="showTab('implementation', this)">💻 Flutter Implementation</button>
            <button class="nav-tab" onclick="showTab('configuration', this)">⚙️ Configuration</button>
            <button class="nav-tab" onclick="showTab('studio', this)">🎨 Conversion Studio</button>
            <button class="nav-tab" onclick="showTab('requirements', this)">📋 Technical Requirements</button>
            <button class="nav-tab" onclick="showTab('demo', this)">🎮 Interactive Demo</button>
        </div>

        <div class="content-panel">
            <!-- SKAN Overview Tab - COMPLETE FROM REFERENCE -->
            <div id="overview" class="tab-content active">
                <h2 class="section-title">What is SKAdNetwork (SKAN)?</h2>
                
                <div class="info-card">
                    <h3>📱 Introduction</h3>
                    <p>SKAdNetwork is Apple's privacy-preserving attribution framework introduced to maintain user privacy while enabling app install attribution and campaign measurement.</p>
                </div>

                <div class="info-card">
                    <h3>🔒 Why Was SKAN Introduced?</h3>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>iOS 14.5+ App Tracking Transparency (ATT) framework</li>
                        <li>User privacy protection - no device-level data sharing</li>
                        <li>Aggregate campaign performance measurement</li>
                        <li>Elimination of IDFA dependency</li>
                    </ul>
                </div>

                <div class="flow-diagram">
                    <h3>📈 SKAN Data Flow</h3>
                    <div class="flow-step">
                        <strong>1. Ad Display</strong>
                        <p>User sees ad in source app</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>2. App Install</strong>
                        <p>User installs advertised app from App Store</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>3. Conversion Value Update</strong>
                        <p>App updates conversion value (0-63) based on user actions</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>4. Timer Window</strong>
                        <p>24-48 hour timer + random delay</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>5. Postback to Ad Network</strong>
                        <p>Apple sends attribution data to ad network</p>
                    </div>
                </div>

                <h2 class="section-title" style="margin-top: 40px;">Digital App Signals in SKAN</h2>

                <div class="info-card">
                    <h3>1️⃣ Primary SKAN Signals</h3>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">📱 Conversion Value (CV)</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>Range:</strong> 0-63 (6-bit value)</li>
                        <li><strong>Purpose:</strong> Encodes post-install user behavior</li>
                        <li><strong>Update Window:</strong> 0-72 hours post-install</li>
                        <li><strong>Key Rule:</strong> Can only increase, never decrease</li>
                    </ul>
                    
                    <div class="code-container" style="margin-top: 15px;">
                        <div class="code-header">
                            <span class="code-language">Swift - iOS Implementation</span>
                        </div>
                        <div class="code-content">// Update conversion value in iOS
SKAdNetwork.updateConversionValue(42) // Updates to value 42</div>
                    </div>

                    <h4 style="color: #667eea; margin-top: 20px;">🎯 Source App ID</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>What it is:</strong> Bundle ID of app where ad was displayed</li>
                        <li><strong>Privacy Threshold:</strong> Only shared if enough installs occur</li>
                        <li><strong>Purpose:</strong> Helps identify which publisher app drove the install</li>
                    </ul>

                    <h4 style="color: #667eea; margin-top: 20px;">🏷️ Campaign ID</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>Range:</strong> 1-100</li>
                        <li><strong>Purpose:</strong> Identifies which ad campaign drove the install</li>
                        <li><strong>Configuration:</strong> Set by advertiser in ad network</li>
                    </ul>
                </div>

                <div class="info-card">
                    <h3>2️⃣ SKAN 4.0+ Additional Signals</h3>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">📈 Coarse Conversion Value</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>Low:</strong> Basic user engagement</li>
                        <li><strong>Medium:</strong> Moderate user value</li>
                        <li><strong>High:</strong> High-value user actions</li>
                        <li><strong>Null:</strong> If insufficient data for privacy</li>
                    </ul>

                    <h4 style="color: #667eea; margin-top: 20px;">🔗 Source Domain</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Web-to-app attribution support</li>
                        <li>Shows domain where ad was displayed (Safari/web)</li>
                        <li>Enables mobile web campaign tracking</li>
                    </ul>

                    <h4 style="color: #667eea; margin-top: 20px;">⏰ Multiple Conversion Windows</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                        <strong>Window 1:</strong> 0-2 days (fine-grained CV)<br>
                        <strong>Window 2:</strong> 3-7 days (coarse CV)<br>
                        <strong>Window 3:</strong> 8-35 days (coarse CV only)
                    </div>
                </div>

                <div class="info-card">
                    <h3>3️⃣ Conversion Value Mapping Examples</h3>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">💰 Revenue-Focused Schema</h4>
                    <div class="code-container" style="margin-top: 10px;">
                        <div class="code-header">
                            <span class="code-language">6-Bit Mapping</span>
                        </div>
                        <div class="code-content">Bits 0-1: Revenue Bands
  00 = $0
  01 = $1-50
  10 = $51-100
  11 = $100+

Bit 2: Subscription Started (1/0)
Bit 3: Premium Feature Used (1/0)
Bit 4: Tutorial Completed (1/0)
Bit 5: Social Share (1/0)</div>
                    </div>

                    <h4 style="color: #667eea; margin-top: 20px;">📊 Engagement-Focused Schema</h4>
                    <div class="code-container" style="margin-top: 10px;">
                        <div class="code-header">
                            <span class="code-language">6-Bit Mapping</span>
                        </div>
                        <div class="code-content">Bits 0-2: Session Count
  000 = 0 sessions
  001 = 1 session
  010 = 2-3 sessions
  011 = 4-5 sessions
  100 = 6-10 sessions
  101 = 11+ sessions

Bit 3: Push Notification Enabled
Bit 4: Account Created
Bit 5: Content Viewed</div>
                    </div>
                </div>
            </div>

            <!-- AppsFlyer SKAN Tab - COMPLETE FROM REFERENCE -->
            <div id="appsflyer" class="tab-content">
                <h2 class="section-title">AppsFlyer SKAN Solution</h2>

                <div class="info-card">
                    <h3>🎯 What is AppsFlyer SKAN?</h3>
                    <p>AppsFlyer's advanced solution that maximizes the value of SKAdNetwork data through intelligent conversion value mapping, predictive analytics, and comprehensive reporting.</p>
                </div>

                <div class="flow-diagram">
                    <h3>🔄 AppsFlyer SKAN Data Flow</h3>
                    <div class="flow-step">
                        <strong>1. SDK Integration</strong>
                        <p>AppsFlyer SDK tracks events and manages CV updates</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>2. Event Mapping</strong>
                        <p>Events mapped to 6-bit conversion value schema</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>3. Smart CV Management</strong>
                        <p>Optimized CV updates within Apple's constraints</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>4. Data Collection</strong>
                        <p>SKAN postbacks received and processed</p>
                    </div>
                    <div class="flow-arrow">↓</div>
                    <div class="flow-step">
                        <strong>5. Analytics & Reporting</strong>
                        <p>Enriched data with predictive analytics in dashboard</p>
                    </div>
                </div>

                <h2 class="section-title" style="margin-top: 40px;">AppsFlyer Enhanced Digital Signals</h2>

                <div class="info-card">
                    <h3>4️⃣ AppsFlyer Enhanced Signals</h3>
                    <p>Beyond standard SKAN signals, AppsFlyer adds advanced analytics and predictions:</p>
                    
                    <h4 style="color: #667eea; margin-top: 15px;">🤖 Predictive Analytics</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>Predicted LTV:</strong> Machine learning models estimate lifetime value based on early user behavior</li>
                        <li><strong>Churn Probability:</strong> Likelihood of user retention calculated from engagement patterns</li>
                        <li><strong>Conversion Probability:</strong> Chance of making purchase based on similar user cohorts</li>
                        <li><strong>Revenue Predictions:</strong> Expected revenue in next 7, 14, 30 days</li>
                    </ul>

                    <h4 style="color: #667eea; margin-top: 20px;">📊 Aggregated Metrics</h4>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li><strong>ARPU (Average Revenue Per User):</strong> Revenue metrics across campaigns</li>
                        <li><strong>Retention Rates:</strong> Day 1, 3, 7, 14, 30 retention cohorts</li>
                        <li><strong>Cohort Performance:</strong> Comparative analysis across user segments</li>
                        <li><strong>ROI Calculations:</strong> Campaign profitability analysis</li>
                    </ul>
                </div>

                <div class="info-card">
                    <h3>5️⃣ Signal Flow in AppsFlyer</h3>
                    
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Flutter/Dart Implementation</span>
                            <button class="copy-btn" onclick="copyCode('signal-flow')">📋 Copy Code</button>
                        </div>
                        <div class="code-content" id="signal-flow">class SKANSignalManager {
  int _conversionValue = 0;
  
  // Update conversion value based on user actions
  void updateSignals({
    double? revenue,
    bool? signedUp,
    bool? madePayment,
    bool? subscribedPremium,
    int? sessionCount,
  }) {
    int newCV = _conversionValue;
    
    // Revenue bands (bits 0-1)
    if (revenue != null) {
      if (revenue > 100) {
        newCV |= 0x03; // Set bits 0-1 to 11
      } else if (revenue > 50) {
        newCV |= 0x02; // Set bits 0-1 to 10
      } else if (revenue > 0) {
        newCV |= 0x01; // Set bits 0-1 to 01
      }
    }
    
    // User actions (bits 2-5)
    if (signedUp == true) newCV |= 0x04;      // Bit 2
    if (madePayment == true) newCV |= 0x08;    // Bit 3
    if (subscribedPremium == true) newCV |= 0x10; // Bit 4
    
    // Session engagement (bit 5)
    if (sessionCount != null && sessionCount > 3) {
      newCV |= 0x20; // Bit 5
    }
    
    // Only update if value increases
    if (newCV > _conversionValue) {
      _conversionValue = newCV;
      _sendToAppsFlyer(newCV);
    }
  }
  
  void _sendToAppsFlyer(int cv) {
    // AppsFlyer handles the actual SKAN update
    print('Updating SKAN CV to: $cv');
  }
}</div>
                    </div>
                </div>

                <div class="info-card">
                    <h3>6️⃣ Privacy-Preserving Signals</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <div>
                            <h4 style="color: #ff6b6b;">❌ What SKAN Does NOT Send:</h4>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>User ID or Device ID (IDFA)</li>
                                <li>Exact timestamp of install</li>
                                <li>Exact timestamp of conversion</li>
                                <li>IP address</li>
                                <li>Detailed user demographics</li>
                                <li>Exact revenue amounts</li>
                            </ul>
                        </div>
                        <div>
                            <h4 style="color: #51cf66;">✅ What SKAN DOES Send:</h4>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                <li>Aggregated conversion value</li>
                                <li>Campaign ID</li>
                                <li>Source app (with threshold)</li>
                                <li>Coarse timing (window-based)</li>
                                <li>Install validation</li>
                                <li>Coarse conversion value (SKAN 4.0)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="info-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3>🚀 AppsFlyer SKAN Advantages</h3>
                    <ul style="margin-left: 20px; margin-top: 15px; color: white;">
                        <li>✨ <strong>Enhanced Analytics:</strong> Go beyond basic SKAN with predictive models</li>
                        <li>📊 <strong>Unified Dashboard:</strong> Single view for all attribution data</li>
                        <li>🔮 <strong>Predictive Insights:</strong> LTV and churn predictions from limited data</li>
                        <li>🎯 <strong>Smart Optimization:</strong> AI-powered CV schema recommendations</li>
                        <li>🛡️ <strong>Privacy Compliant:</strong> Full adherence to Apple's guidelines</li>
                        <li>⚡ <strong>Real-time Processing:</strong> Immediate CV updates and monitoring</li>
                        <li>🔧 <strong>Easy Integration:</strong> Simple SDK with Flutter support</li>
                    </ul>
                </div>
            </div>

            <!-- Flutter Implementation Tab - WITH CODE DIRECTLY ON PAGE -->
            <div id="implementation" class="tab-content">
                <h2 class="section-title">Flutter/Dart Implementation - Complete Code</h2>
                
                <p style="margin-bottom: 20px;">Complete implementation handling all three scenarios: consent granted, consent denied, and runtime consent changes.</p>
                
                <!-- Main Manager Implementation -->
                <div class="code-section">
                    <h3>📱 Complete SKAN Manager (appsflyer_skan_manager.dart)</h3>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Flutter/Dart</span>
                            <button class="copy-btn" onclick="copyCode('manager-code')">📋 Copy Code</button>
                        </div>
                        <div class="code-content" id="manager-code">import 'package:appsflyer_sdk/appsflyer_sdk.dart';
import 'package:app_tracking_transparency/app_tracking_transparency.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'dart:async';
import 'dart:io' show Platform;

/// Complete AppsFlyer SKAN Manager Class
/// Handles all tracking scenarios: consent granted, denied, and runtime changes
class AppsFlyerSKANManager {
  // Singleton pattern
  static final AppsFlyerSKANManager _instance = AppsFlyerSKANManager._internal();
  factory AppsFlyerSKANManager() => _instance;
  AppsFlyerSKANManager._internal();

  // SDK instance
  AppsflyerSdk? _appsflyerSdk;
  
  // State management
  bool _isInitialized = false;
  bool _hasConsent = false;
  bool _isStopped = false;
  TrackingStatus? _currentTrackingStatus;
  
  // Stream for consent changes
  final _consentStateController = StreamController<bool>.broadcast();
  Stream<bool> get consentStateStream => _consentStateController.stream;
  
  // Configuration
  static const String AF_DEV_KEY = 'YOUR_APPSFLYER_DEV_KEY';
  static const String APP_ID = 'YOUR_APP_STORE_ID';
  
  /// Initialize SDK based on consent state
  Future<void> initialize() async {
    print('🚀 Initializing AppsFlyerSKANManager...');
    
    if (!Platform.isIOS) {
      print('⚠️ SKAN is iOS only');
      return;
    }
    
    if (_isInitialized) {
      print('⚠️ Already initialized');
      return;
    }
    
    await _checkAndHandleTrackingStatus();
    _isInitialized = true;
    print('✅ Initialization complete');
  }
  
  /// Check ATT status and initialize accordingly
  Future<void> _checkAndHandleTrackingStatus() async {
    _currentTrackingStatus = await AppTrackingTransparency.trackingAuthorizationStatus;
    
    print('📱 ATT Status: $_currentTrackingStatus');
    
    switch (_currentTrackingStatus) {
      case TrackingStatus.notDetermined:
        await _requestTrackingPermission();
        break;
      case TrackingStatus.authorized:
        await _initializeWithConsent();
        break;
      case TrackingStatus.denied:
      case TrackingStatus.restricted:
        await _initializeWithoutConsent();
        break;
      default:
        await _initializeWithoutConsent();
    }
  }
  
  // =============================================
  // SCENARIO A: CONSENT GRANTED
  // =============================================
  
  Future<void> _initializeWithConsent() async {
    print('✅ SCENARIO A: Initializing with CONSENT GRANTED');
    
    _hasConsent = true;
    _consentStateController.add(true);
    
    // Configure for full tracking
    final options = AppsFlyerOptions(
      afDevKey: AF_DEV_KEY,
      appId: APP_ID,
      showDebug: true,
      timeToWaitForATTUserAuthorization: 10.0,
      disableIDFACollection: false, // ENABLE IDFA
      disableAdvertisingIdentifier: false, // ENABLE ad ID
      disableCollectASA: false, // ENABLE Apple Search Ads
    );
    
    _appsflyerSdk = AppsflyerSdk(options);
    
    // Enable all callbacks
    _appsflyerSdk!.initSdk(
      registerConversionDataCallback: true,
      registerOnAppOpenAttributionCallback: true,
      registerOnDeepLinkingCallback: true
    );
    
    // Start SDK
    _appsflyerSdk!.startSDK();
    _isStopped = false;
    
    print('🚀 Full tracking enabled with IDFA');
  }
  
  // =============================================
  // SCENARIO B: CONSENT DENIED
  // =============================================
  
  Future<void> _initializeWithoutConsent() async {
    print('🔒 SCENARIO B: Initializing with CONSENT DENIED');
    
    _hasConsent = false;
    _consentStateController.add(false);
    
    // Configure for SKAN-only
    final options = AppsFlyerOptions(
      afDevKey: AF_DEV_KEY,
      appId: APP_ID,
      showDebug: false,
      timeToWaitForATTUserAuthorization: 0.0,
      disableIDFACollection: true, // DISABLE IDFA
      disableAdvertisingIdentifier: true, // DISABLE ad ID
      disableCollectASA: true, // DISABLE Apple Search Ads
    );
    
    _appsflyerSdk = AppsflyerSdk(options);
    
    // Minimal callbacks
    _appsflyerSdk!.initSdk(
      registerConversionDataCallback: false,
      registerOnAppOpenAttributionCallback: false,
      registerOnDeepLinkingCallback: false
    );
    
    // Enable anonymization
    _appsflyerSdk!.anonymizeUser(true);
    
    // Start SDK
    _appsflyerSdk!.startSDK();
    _isStopped = false;
    
    print('🔐 SKAN-only mode activated');
  }
  
  // =============================================
  // SCENARIO C: RUNTIME CONSENT CHANGES
  // =============================================
  
  Future<void> handleConsentChange(bool newConsentStatus) async {
    print('🔄 SCENARIO C: Consent change detected');
    print('🔄 From $_hasConsent to $newConsentStatus');
    
    if (_hasConsent == newConsentStatus) {
      print('ℹ️ No change needed');
      return;
    }
    
    if (newConsentStatus) {
      await _transitionToConsentGranted();
    } else {
      await _transitionToConsentDenied();
    }
  }
}</div>
                    </div>
                </div>

                <!-- Event Tracking Examples -->
                <div class="code-section">
                    <h3>📊 Event Tracking (event_tracker.dart)</h3>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Flutter/Dart</span>
                            <button class="copy-btn" onclick="copyCode('events-code')">📋 Copy Code</button>
                        </div>
                        <div class="code-content" id="events-code">import 'appsflyer_skan_manager.dart';

class EventTracker {
  final _manager = AppsFlyerSKANManager();
  
  /// Track purchase - adapts based on consent
  Future<void> trackPurchase({
    required double revenue,
    required String currency,
    required String productId,
    String? userId,
  }) async {
    final params = <String, dynamic>{
      'af_revenue': revenue,
      'af_currency': currency,
    };
    
    // Add details only with consent
    if (_manager.hasConsent) {
      params['af_content_id'] = productId;
      if (userId != null) params['customer_user_id'] = userId;
      print('💰 Full purchase tracking');
    } else {
      print('💰 Limited purchase tracking (SKAN only)');
    }
    
    await _manager.logEvent('af_purchase', params);
  }
  
  /// Track HBB Revenue
  Future<void> trackHBBRevenue(double amount) async {
    await _manager.logEvent('hbb_purchase', {
      'af_revenue': amount,
      'af_currency': 'USD',
      'channel': 'HBB',
    });
    print('📺 HBB Revenue: $amount');
  }
  
  /// Track Mobile Revenue
  Future<void> trackMobileRevenue(double amount) async {
    await _manager.logEvent('mobile_purchase', {
      'af_revenue': amount,
      'af_currency': 'USD',
      'platform': 'mobile',
    });
    print('📱 Mobile Revenue: $amount');
  }
  
  /// Track Sign Up
  Future<void> trackSignUp(String method, String? email) async {
    final params = <String, dynamic>{
      'af_registration_method': method,
    };
    
    // Only include email with consent
    if (_manager.hasConsent && email != null) {
      params['email_hash'] = email.hashCode.toString();
    }
    
    await _manager.logEvent('af_complete_registration', params);
    print('✏️ Sign up: $method');
  }
}</div>
                    </div>
                </div>

                <!-- Main App Entry -->
                <div class="code-section">
                    <h3>🚀 App Entry Point (main.dart)</h3>
                    <div class="code-container">
                        <div class="code-header">
                            <span class="code-language">Flutter/Dart</span>
                            <button class="copy-btn" onclick="copyCode('main-code')">📋 Copy Code</button>
                        </div>
                        <div class="code-content" id="main-code">import 'package:flutter/material.dart';
import 'appsflyer_skan_manager.dart';
import 'event_tracker.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize AppsFlyer SKAN Manager
  final manager = AppsFlyerSKANManager();
  await manager.initialize();
  
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'AppsFlyer SKAN Demo',
      theme: ThemeData(primarySwatch: Colors.blue),
      home: HomeScreen(),
    );
  }
}

class HomeScreen extends StatelessWidget {
  final _tracker = EventTracker();
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: Text('AppsFlyer SKAN Demo'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            ElevatedButton(
              onPressed: () => _tracker.trackPurchase(
                revenue: 99.99,
                currency: 'USD',
                productId: 'PRD123',
              ),
              child: Text('Track Purchase'),
            ),
            SizedBox(height: 16),
            ElevatedButton(
              onPressed: () => _tracker.trackSignUp('email', 'user@example.com'),
              child: Text('Track Sign Up'),
            ),
          ],
        ),
      ),
    );
  }
}</div>
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="configuration" class="tab-content">
                <h2 class="section-title">AppsFlyer Dashboard Configuration</h2>

                <div class="info-card">
                    <h3>📋 Step-by-Step Configuration</h3>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 2;">
                        <li><strong>Access SKAN Dashboard:</strong> Navigate to AppsFlyer → SKAN → Conversion Studio</li>
                        <li><strong>Create Schema:</strong> Click "Create New Schema" or edit existing</li>
                        <li><strong>Select Measurement Mode:</strong> Choose between "Revenue" or "Engagement" focus</li>
                        <li><strong>Configure Conversion Values:</strong> Map your 6-bit schema (0-63 values)</li>
                        <li><strong>Set Event Priorities:</strong> Order events by business importance</li>
                        <li><strong>Define Measurement Windows:</strong> Set activity windows (0-24h, 24-48h, 48-72h)</li>
                        <li><strong>Test Configuration:</strong> Use sandbox mode for validation</li>
                        <li><strong>Deploy Schema:</strong> Activate for production traffic</li>
                    </ol>
                </div>

                <h3 style="margin-top: 30px;">🎯 Example Configuration: 6-Bit Schema</h3>
                
                <div class="schema-grid">
                    <div class="schema-card">
                        <div class="bit-value">Bits 0-1</div>
                        <div class="event-name">Revenue Bands</div>
                        <div class="event-type">$0, $1-50, $51-100, $100+</div>
                    </div>
                    
                    <div class="schema-card">
                        <div class="bit-value">Bit 2</div>
                        <div class="event-name">HBB Revenue</div>
                        <div class="event-type">Yes/No Indicator</div>
                    </div>
                    
                    <div class="schema-card">
                        <div class="bit-value">Bit 3</div>
                        <div class="event-name">Mobile Revenue</div>
                        <div class="event-type">Yes/No Indicator</div>
                    </div>
                    
                    <div class="schema-card">
                        <div class="bit-value">Bit 4</div>
                        <div class="event-name">Sign Up</div>
                        <div class="event-type">Completed/Not</div>
                    </div>
                    
                    <div class="schema-card">
                        <div class="bit-value">Bit 5</div>
                        <div class="event-name">Add to Cart</div>
                        <div class="event-type">Performed/Not</div>
                    </div>
                    
                    <div class="schema-card">
                        <div class="bit-value">Bit 6</div>
                        <div class="event-name">Initiate Checkout</div>
                        <div class="event-type">Started/Not</div>
                    </div>
                </div>
            </div>

            <!-- Conversion Studio Tab -->
            <div id="studio" class="tab-content">
                <h2 class="section-title">🎨 SKAN Conversion Studio & Dashboard Analytics</h2>
                
                <div class="info-card">
                    <h3>📊 Understanding the 64 Conversion Value Bundles</h3>
                    <p>AppsFlyer's Conversion Studio allows you to create up to <strong>63 prioritized measurement bundles</strong> (0-63) to capture the full range of user behaviors within SKAN's 6-bit limitation.</p>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 15px;">
                        <h4 style="color: #667eea;">How the 64 Values Work:</h4>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Value 0:</strong> Reserved for install (no additional events)</li>
                            <li><strong>Values 1-63:</strong> Available for custom event combinations</li>
                            <li><strong>6-bit Binary:</strong> 2^6 = 64 possible combinations</li>
                            <li><strong>Progressive Nature:</strong> Values can only increase, never decrease</li>
                        </ul>
                    </div>
                </div>

                <div class="info-card">
                    <h3>🎯 Campaign ID Constraints by Ad Network</h3>
                    <p>SKAN allows Campaign IDs from 1-100, but each ad network has different limitations:</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        
                        <div style="background: white; border: 2px solid #4267B2; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #4267B2; margin-bottom: 10px;">📘 Meta (Facebook)</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Campaign IDs:</strong> 100 (Full range)</li>
                                <li><strong>Structure:</strong> 3-digit hierarchical</li>
                                <li><strong>Best Practice:</strong> Use 10 campaigns × 10 ad sets</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; border: 2px solid #4285F4; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #4285F4; margin-bottom: 10px;">🔍 Google Ads</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Campaign IDs:</strong> 100 (Full range)</li>
                                <li><strong>Structure:</strong> Flexible mapping</li>
                                <li><strong>Best Practice:</strong> Group by campaign type</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; border: 2px solid #000000; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #000000; margin-bottom: 10px;">🎵 TikTok</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Campaign IDs:</strong> 100 (Full range)</li>
                                <li><strong>Limitation:</strong> One ID per campaign</li>
                                <li><strong>Best Practice:</strong> Reserve IDs by objective</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; border: 2px solid #FFFC00; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #333; margin-bottom: 10px;">👻 Snapchat</h4>
                            <ul style="margin-left: 20px;">
                                <li><strong>Campaign IDs:</strong> 63 maximum</li>
                                <li><strong>Structure:</strong> Campaign-based</li>
                                <li><strong>Best Practice:</strong> Focus on top campaigns</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Requirements Tab -->
            <div id="requirements" class="tab-content">
                <h2 class="section-title">Technical Requirements</h2>
                
                <div class="info-card">
                    <h3>TR1: AppsFlyer Flutter SDK Integration</h3>
                    <p>GitHub: <a href="https://github.com/AppsFlyerSDK/appsflyer-flutter-plugin" target="_blank">AppsFlyer Flutter Plugin</a></p>
                </div>

                <div class="info-card">
                    <h3>TR2: SKAN Network IDs</h3>
                    <p>GitHub: <a href="https://github.com/skadnetwork/ad-network-ids" target="_blank">SKAdNetwork ID Registry</a></p>
                </div>

                <div class="info-card">
                    <h3>TR3 & TR4: Testing</h3>
                    <p>Documentation: <a href="https://support.appsflyer.com/hc/en-us/articles/207032066" target="_blank">SKAdTest Postback Testing</a></p>
                </div>

                <div class="info-card">
                    <h3>TR5: Developer Documentation</h3>
                    <p>Provide complete documentation including setup guide, QA scenarios, and API reference.</p>
                </div>
            </div>

            <!-- Interactive Demo Tab -->
            <div id="demo" class="tab-content">
                <h2 class="section-title">Interactive SKAN Simulator</h2>

                <div class="interactive-demo">
                    <h3>🎮 Simulate SKAN Event Flow</h3>
                    <p>Click events to see how they update the conversion value in real-time!</p>
                    
                    <div class="demo-controls">
                        <button class="demo-btn" onclick="addEvent('revenue')">💰 Revenue $150</button>
                        <button class="demo-btn" onclick="addEvent('hbb')">📺 HBB Revenue</button>
                        <button class="demo-btn" onclick="addEvent('mobile')">📱 Mobile Revenue</button>
                        <button class="demo-btn" onclick="addEvent('signup')">✏️ Sign Up</button>
                        <button class="demo-btn" onclick="addEvent('cart')">🛒 Add to Cart</button>
                        <button class="demo-btn" onclick="addEvent('checkout')">💳 Checkout</button>
                        <button class="demo-btn" onclick="resetDemo()">🔄 Reset</button>
                    </div>
                    
                    <div class="demo-output">
                        <h4>Current State:</h4>
                        <p><span class="status-indicator status-denied"></span>Waiting for events...</p>
                        <div id="conversion-display" style="margin-top: 15px;">
                            <p><strong>Binary:</strong> <span class="highlight" id="binary">000000</span></p>
                            <p><strong>Decimal CV:</strong> <span class="highlight" id="decimal">0</span></p>
                            <p><strong>Events Tracked:</strong> <span id="events">None</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function showTab(tabId, button) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.add('active');
            button.classList.add('active');
        }

        // Demo state
        let conversionState = {
            revenue: 0,
            hbb_revenue: false,
            mobile_revenue: false,
            signup: false,
            add_cart: false,
            checkout: false
        };

        function addEvent(type) {
            switch(type) {
                case 'revenue': conversionState.revenue = 3; break;
                case 'hbb': conversionState.hbb_revenue = true; break;
                case 'mobile': conversionState.mobile_revenue = true; break;
                case 'signup': conversionState.signup = true; break;
                case 'cart': conversionState.add_cart = true; break;
                case 'checkout': conversionState.checkout = true; break;
            }
            updateConversionDisplay();
        }

        function resetDemo() {
            conversionState = {
                revenue: 0,
                hbb_revenue: false,
                mobile_revenue: false,
                signup: false,
                add_cart: false,
                checkout: false
            };
            updateConversionDisplay();
        }

        function updateConversionDisplay() {
            let binary = '';
            binary += conversionState.checkout ? '1' : '0';
            binary += conversionState.add_cart ? '1' : '0';
            binary += conversionState.signup ? '1' : '0';
            binary += conversionState.mobile_revenue ? '1' : '0';
            binary += conversionState.hbb_revenue ? '1' : '0';
            binary += conversionState.revenue.toString(2).padStart(2, '0');
            
            binary = binary.split('').reverse().join('');
            const decimal = parseInt(binary, 2);
            
            document.getElementById('binary').textContent = binary;
            document.getElementById('decimal').textContent = decimal;
            
            const trackedEvents = [];
            if (conversionState.revenue > 0) trackedEvents.push('Revenue Band 3');
            if (conversionState.hbb_revenue) trackedEvents.push('HBB Revenue');
            if (conversionState.mobile_revenue) trackedEvents.push('Mobile Revenue');
            if (conversionState.signup) trackedEvents.push('Sign Up');
            if (conversionState.add_cart) trackedEvents.push('Add to Cart');
            if (conversionState.checkout) trackedEvents.push('Checkout');
            
            document.getElementById('events').textContent = trackedEvents.length > 0 ? trackedEvents.join(', ') : 'None';
        }

        // Copy code functionality
        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const textArea = document.createElement('textarea');
            textArea.value = codeElement.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            event.target.textContent = '✅ Copied!';
            setTimeout(() => {
                event.target.textContent = '📋 Copy Code';
            }, 2000);
        }
    </script>
</body>
</html>
